# Module message_panel core

В модуле сосредоточены базовые механики и архитектурный каркас компонента "Панель ввода сообщений"

## Архитектура
 Панель ввода состоит из четырёх основных компонентов: 
 - Controller - публичный API компонента для взаимодействия с прикладным кодом
 - StateMachine - машина состояний. Обеспечивает изоляцию бизнес правил и отображения
 - ViewModel - модель представления в классическом понимании
 - View - представление, внешний вид панели ввода

### Взаимодействие компонентов
 При обновлении панели ввода важно чётко разграничивать ответственности её 
 компонентов, чтобы не увеличивать связность кода.
 
 ```mermaid
graph TD
    Controller -->|Публикует программное событие| StateMachine
    StateMachine --> |Модифицирует ViewModel| ViewModel
    StateMachine --> |Переходит в другое состоиение| StateMachine
    ViewModel --> |Применяет состояние| View
    ViewModel --> |Оповещает текущее состояние об изменениях| StateMachine
    View --> |Публикует пользовательские события| ViewModel
```
 
 - Controller публикует события в StateMachine. На этом уровне в манину состояний 
    могут публиковаться только пользовательские события, события переходов на 
    этому уровне публиковать запрещено. Модификации контроллера могут содержать 
    узкоспециализированные прикладные методы, для публикации прикладных событий 
    в переопределённый граф переходов
 - StateMachine - получает события от контроллера и в соответствии с ними 
    модифицирует ViewModel или переводит машину в другое состояние
 - ViewModel - хранение состояние внешнего вида, а так же инкапсулирует правила 
    его модификации. Состояния в машине могут подписываться на события ViewModel
    и производить дополнительные модификации ViewModel, а так же публиковать 
    события переходов для машины
 - View - отвечает за размещение UI компонентов на экране, а так же доставку 
    событий от конечного пользователя во ViewModel

### Базовый граф переходов

![Граф переходов](https://mermaid.ink/img/eyJjb2RlIjoic3RhdGVEaWFncmFtLXYyXG4gICAgWypdIC0tPiBEaXNhYmxlZFN0YXRlXG4gICAgRGlzYWJsZWRTdGF0ZSAtLT4gQ2xlYW5TZW5kU3RhdGVcbiAgICBEaXNhYmxlZFN0YXRlIC0tPiBEcmFmdExvYWRpbmdTdGF0ZVxuICAgIFxuICAgIENsZWFuU2VuZFN0YXRlIC0tPiBTaW1wbGVTZW5kU3RhdGVcbiAgICBDbGVhblNlbmRTdGF0ZSAtLT4gU2VuZGluZ01lc3NhZ2VTdGF0ZVxuICAgIENsZWFuU2VuZFN0YXRlIC0tPiBSZXBsYXlpbmdTdGF0ZVxuICAgIENsZWFuU2VuZFN0YXRlIC0tPiBEaXNhYmxlZFN0YXRlXG4gICAgQ2xlYW5TZW5kU3RhdGUgLS0-IEVkaXRpbmdTdGF0ZVxuICAgIENsZWFuU2VuZFN0YXRlIC0tPiBRdW90aW5nU3RhdGVcbiAgICBDbGVhblNlbmRTdGF0ZSAtLT4gU2VuZGluZ0F1ZGlvTWVzc2FnZVN0YXRlXG4gICAgXG4gICAgRHJhZnRMb2FkaW5nU3RhdGUgLS0-IENsZWFuU2VuZFN0YXRlXG4gICAgRHJhZnRMb2FkaW5nU3RhdGUgLS0-IFJlcGxheWluZ1N0YXRlXG4gICAgRHJhZnRMb2FkaW5nU3RhdGUgLS0-IFNpbXBsZVNlbmRTdGF0ZVxuICAgIFxuICAgIFNpbXBsZVNlbmRTdGF0ZSAtLT4gQ2xlYW5TZW5kU3RhdGVcbiAgICBTaW1wbGVTZW5kU3RhdGUgLS0-IFNlbmRpbmdNZXNzYWdlU3RhdGVcbiAgICBTaW1wbGVTZW5kU3RhdGUgLS0-IFJlcGxheWluZ1N0YXRlXG4gICAgU2ltcGxlU2VuZFN0YXRlIC0tPiBEaXNhYmxlZFN0YXRlXG4gICAgU2ltcGxlU2VuZFN0YXRlIC0tPiBFZGl0aW5nU3RhdGVcbiAgICBTaW1wbGVTZW5kU3RhdGUgLS0-IFF1b3RpbmdTdGF0ZVxuICAgIFNpbXBsZVNlbmRTdGF0ZSAtLT4gU2VuZGluZ0F1ZGlvTWVzc2FnZVN0YXRlXG5cbiAgICBTZW5kaW5nTWVzc2FnZVN0YXRlIC0tPiBDbGVhblNlbmRTdGF0ZVxuICAgIFNlbmRpbmdNZXNzYWdlU3RhdGUgLS0-IERyYWZ0TG9hZGluZ1N0YXRlXG5cbiAgICBSZXBsYXlpbmdTdGF0ZSAtLT4gQ2xlYW5TZW5kU3RhdGVcbiAgICBSZXBsYXlpbmdTdGF0ZSAtLT4gU2VuZGluZ01lc3NhZ2VTdGF0ZVxuICAgIFJlcGxheWluZ1N0YXRlIC0tPiBEaXNhYmxlZFN0YXRlXG4gICAgUmVwbGF5aW5nU3RhdGUgLS0-IEVkaXRpbmdTdGF0ZVxuICAgIFJlcGxheWluZ1N0YXRlIC0tPiBSZXBsYXlpbmdTdGF0ZVxuXG4gICAgRWRpdGluZ1N0YXRlIC0tPiBDbGVhblNlbmRTdGF0ZVxuICAgIEVkaXRpbmdTdGF0ZSAtLT4gU2VuZGluZ0VkaXRNZXNzYWdlU3RhdGVcbiAgICBFZGl0aW5nU3RhdGUgLS0-IFJlcGxheWluZ1N0YXRlXG4gICAgRWRpdGluZ1N0YXRlIC0tPiBEaXNhYmxlZFN0YXRlXG4gICAgRWRpdGluZ1N0YXRlIC0tPiBFZGl0aW5nU3RhdGVcblxuICAgIFF1b3RpbmdTdGF0ZSAtLT4gU2ltcGxlU2VuZFN0YXRlXG4gICAgUXVvdGluZ1N0YXRlIC0tPiBTZW5kaW5nTWVzc2FnZVN0YXRlXG4gICAgUXVvdGluZ1N0YXRlIC0tPiBFZGl0aW5nU3RhdGVcbiAgICBRdW90aW5nU3RhdGUgLS0-IERpc2FibGVkU3RhdGVcbiAgICBRdW90aW5nU3RhdGUgLS0-IFF1b3RpbmdTdGF0ZVxuXG4gICAgU2VuZGluZ0F1ZGlvTWVzc2FnZVN0YXRlIC0tPiBDbGVhblNlbmRTdGF0ZVxuICAgIFNlbmRpbmdBdWRpb01lc3NhZ2VTdGF0ZSAtLT4gRHJhZnRMb2FkaW5nU3RhdGVcblxuICAgIFNlbmRpbmdFZGl0TWVzc2FnZVN0YXRlIC0tPiBDbGVhblNlbmRTdGF0ZVxuICAgIFNlbmRpbmdFZGl0TWVzc2FnZVN0YXRlIC0tPiBEcmFmdExvYWRpbmdTdGF0ZVxuICAgICAgICAgICAgIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQiLCJ0aGVtZVZhcmlhYmxlcyI6eyJiYWNrZ3JvdW5kIjoid2hpdGUiLCJwcmltYXJ5Q29sb3IiOiIjRUNFQ0ZGIiwic2Vjb25kYXJ5Q29sb3IiOiIjZmZmZmRlIiwidGVydGlhcnlDb2xvciI6ImhzbCg4MCwgMTAwJSwgOTYuMjc0NTA5ODAzOSUpIiwicHJpbWFyeUJvcmRlckNvbG9yIjoiaHNsKDI0MCwgNjAlLCA4Ni4yNzQ1MDk4MDM5JSkiLCJzZWNvbmRhcnlCb3JkZXJDb2xvciI6ImhzbCg2MCwgNjAlLCA4My41Mjk0MTE3NjQ3JSkiLCJ0ZXJ0aWFyeUJvcmRlckNvbG9yIjoiaHNsKDgwLCA2MCUsIDg2LjI3NDUwOTgwMzklKSIsInByaW1hcnlUZXh0Q29sb3IiOiIjMTMxMzAwIiwic2Vjb25kYXJ5VGV4dENvbG9yIjoiIzAwMDAyMSIsInRlcnRpYXJ5VGV4dENvbG9yIjoicmdiKDkuNTAwMDAwMDAwMSwgOS41MDAwMDAwMDAxLCA5LjUwMDAwMDAwMDEpIiwibGluZUNvbG9yIjoiIzMzMzMzMyIsInRleHRDb2xvciI6IiMzMzMiLCJtYWluQmtnIjoiI0VDRUNGRiIsInNlY29uZEJrZyI6IiNmZmZmZGUiLCJib3JkZXIxIjoiIzkzNzBEQiIsImJvcmRlcjIiOiIjYWFhYTMzIiwiYXJyb3doZWFkQ29sb3IiOiIjMzMzMzMzIiwiZm9udEZhbWlseSI6IlwidHJlYnVjaGV0IG1zXCIsIHZlcmRhbmEsIGFyaWFsIiwiZm9udFNpemUiOiIxNnB4IiwibGFiZWxCYWNrZ3JvdW5kIjoiI2U4ZThlOCIsIm5vZGVCa2ciOiIjRUNFQ0ZGIiwibm9kZUJvcmRlciI6IiM5MzcwREIiLCJjbHVzdGVyQmtnIjoiI2ZmZmZkZSIsImNsdXN0ZXJCb3JkZXIiOiIjYWFhYTMzIiwiZGVmYXVsdExpbmtDb2xvciI6IiMzMzMzMzMiLCJ0aXRsZUNvbG9yIjoiIzMzMyIsImVkZ2VMYWJlbEJhY2tncm91bmQiOiIjZThlOGU4IiwiYWN0b3JCb3JkZXIiOiJoc2woMjU5LjYyNjE2ODIyNDMsIDU5Ljc3NjUzNjMxMjglLCA4Ny45MDE5NjA3ODQzJSkiLCJhY3RvckJrZyI6IiNFQ0VDRkYiLCJhY3RvclRleHRDb2xvciI6ImJsYWNrIiwiYWN0b3JMaW5lQ29sb3IiOiJncmV5Iiwic2lnbmFsQ29sb3IiOiIjMzMzIiwic2lnbmFsVGV4dENvbG9yIjoiIzMzMyIsImxhYmVsQm94QmtnQ29sb3IiOiIjRUNFQ0ZGIiwibGFiZWxCb3hCb3JkZXJDb2xvciI6ImhzbCgyNTkuNjI2MTY4MjI0MywgNTkuNzc2NTM2MzEyOCUsIDg3LjkwMTk2MDc4NDMlKSIsImxhYmVsVGV4dENvbG9yIjoiYmxhY2siLCJsb29wVGV4dENvbG9yIjoiYmxhY2siLCJub3RlQm9yZGVyQ29sb3IiOiIjYWFhYTMzIiwibm90ZUJrZ0NvbG9yIjoiI2ZmZjVhZCIsIm5vdGVUZXh0Q29sb3IiOiJibGFjayIsImFjdGl2YXRpb25Cb3JkZXJDb2xvciI6IiM2NjYiLCJhY3RpdmF0aW9uQmtnQ29sb3IiOiIjZjRmNGY0Iiwic2VxdWVuY2VOdW1iZXJDb2xvciI6IndoaXRlIiwic2VjdGlvbkJrZ0NvbG9yIjoicmdiYSgxMDIsIDEwMiwgMjU1LCAwLjQ5KSIsImFsdFNlY3Rpb25Ca2dDb2xvciI6IndoaXRlIiwic2VjdGlvbkJrZ0NvbG9yMiI6IiNmZmY0MDAiLCJ0YXNrQm9yZGVyQ29sb3IiOiIjNTM0ZmJjIiwidGFza0JrZ0NvbG9yIjoiIzhhOTBkZCIsInRhc2tUZXh0TGlnaHRDb2xvciI6IndoaXRlIiwidGFza1RleHRDb2xvciI6IndoaXRlIiwidGFza1RleHREYXJrQ29sb3IiOiJibGFjayIsInRhc2tUZXh0T3V0c2lkZUNvbG9yIjoiYmxhY2siLCJ0YXNrVGV4dENsaWNrYWJsZUNvbG9yIjoiIzAwMzE2MyIsImFjdGl2ZVRhc2tCb3JkZXJDb2xvciI6IiM1MzRmYmMiLCJhY3RpdmVUYXNrQmtnQ29sb3IiOiIjYmZjN2ZmIiwiZ3JpZENvbG9yIjoibGlnaHRncmV5IiwiZG9uZVRhc2tCa2dDb2xvciI6ImxpZ2h0Z3JleSIsImRvbmVUYXNrQm9yZGVyQ29sb3IiOiJncmV5IiwiY3JpdEJvcmRlckNvbG9yIjoiI2ZmODg4OCIsImNyaXRCa2dDb2xvciI6InJlZCIsInRvZGF5TGluZUNvbG9yIjoicmVkIiwibGFiZWxDb2xvciI6ImJsYWNrIiwiZXJyb3JCa2dDb2xvciI6IiM1NTIyMjIiLCJlcnJvclRleHRDb2xvciI6IiM1NTIyMjIiLCJjbGFzc1RleHQiOiIjMTMxMzAwIiwiZmlsbFR5cGUwIjoiI0VDRUNGRiIsImZpbGxUeXBlMSI6IiNmZmZmZGUiLCJmaWxsVHlwZTIiOiJoc2woMzA0LCAxMDAlLCA5Ni4yNzQ1MDk4MDM5JSkiLCJmaWxsVHlwZTMiOiJoc2woMTI0LCAxMDAlLCA5My41Mjk0MTE3NjQ3JSkiLCJmaWxsVHlwZTQiOiJoc2woMTc2LCAxMDAlLCA5Ni4yNzQ1MDk4MDM5JSkiLCJmaWxsVHlwZTUiOiJoc2woLTQsIDEwMCUsIDkzLjUyOTQxMTc2NDclKSIsImZpbGxUeXBlNiI6ImhzbCg4LCAxMDAlLCA5Ni4yNzQ1MDk4MDM5JSkiLCJmaWxsVHlwZTciOiJoc2woMTg4LCAxMDAlLCA5My41Mjk0MTE3NjQ3JSkifX19)

Описание графа для генерации изображения в [Mermaid Live Editor](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic3RhdGVEaWFncmFtLXYyXG4gICAgWypdIC0tPiBTdGlsbFxuICAgIFN0aWxsIC0tPiBbKl1cbiAgICBTdGlsbCAtLT4gTW92aW5nXG4gICAgTW92aW5nIC0tPiBTdGlsbFxuICAgIE1vdmluZyAtLT4gQ3Jhc2hcbiAgICBDcmFzaCAtLT4gWypdXG4gICAgICAgICAgICAiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCIsInRoZW1lVmFyaWFibGVzIjp7ImJhY2tncm91bmQiOiJ3aGl0ZSIsInByaW1hcnlDb2xvciI6IiNFQ0VDRkYiLCJzZWNvbmRhcnlDb2xvciI6IiNmZmZmZGUiLCJ0ZXJ0aWFyeUNvbG9yIjoiaHNsKDgwLCAxMDAlLCA5Ni4yNzQ1MDk4MDM5JSkiLCJwcmltYXJ5Qm9yZGVyQ29sb3IiOiJoc2woMjQwLCA2MCUsIDg2LjI3NDUwOTgwMzklKSIsInNlY29uZGFyeUJvcmRlckNvbG9yIjoiaHNsKDYwLCA2MCUsIDgzLjUyOTQxMTc2NDclKSIsInRlcnRpYXJ5Qm9yZGVyQ29sb3IiOiJoc2woODAsIDYwJSwgODYuMjc0NTA5ODAzOSUpIiwicHJpbWFyeVRleHRDb2xvciI6IiMxMzEzMDAiLCJzZWNvbmRhcnlUZXh0Q29sb3IiOiIjMDAwMDIxIiwidGVydGlhcnlUZXh0Q29sb3IiOiJyZ2IoOS41MDAwMDAwMDAxLCA5LjUwMDAwMDAwMDEsIDkuNTAwMDAwMDAwMSkiLCJsaW5lQ29sb3IiOiIjMzMzMzMzIiwidGV4dENvbG9yIjoiIzMzMyIsIm1haW5Ca2ciOiIjRUNFQ0ZGIiwic2Vjb25kQmtnIjoiI2ZmZmZkZSIsImJvcmRlcjEiOiIjOTM3MERCIiwiYm9yZGVyMiI6IiNhYWFhMzMiLCJhcnJvd2hlYWRDb2xvciI6IiMzMzMzMzMiLCJmb250RmFtaWx5IjoiXCJ0cmVidWNoZXQgbXNcIiwgdmVyZGFuYSwgYXJpYWwiLCJmb250U2l6ZSI6IjE2cHgiLCJsYWJlbEJhY2tncm91bmQiOiIjZThlOGU4Iiwibm9kZUJrZyI6IiNFQ0VDRkYiLCJub2RlQm9yZGVyIjoiIzkzNzBEQiIsImNsdXN0ZXJCa2ciOiIjZmZmZmRlIiwiY2x1c3RlckJvcmRlciI6IiNhYWFhMzMiLCJkZWZhdWx0TGlua0NvbG9yIjoiIzMzMzMzMyIsInRpdGxlQ29sb3IiOiIjMzMzIiwiZWRnZUxhYmVsQmFja2dyb3VuZCI6IiNlOGU4ZTgiLCJhY3RvckJvcmRlciI6ImhzbCgyNTkuNjI2MTY4MjI0MywgNTkuNzc2NTM2MzEyOCUsIDg3LjkwMTk2MDc4NDMlKSIsImFjdG9yQmtnIjoiI0VDRUNGRiIsImFjdG9yVGV4dENvbG9yIjoiYmxhY2siLCJhY3RvckxpbmVDb2xvciI6ImdyZXkiLCJzaWduYWxDb2xvciI6IiMzMzMiLCJzaWduYWxUZXh0Q29sb3IiOiIjMzMzIiwibGFiZWxCb3hCa2dDb2xvciI6IiNFQ0VDRkYiLCJsYWJlbEJveEJvcmRlckNvbG9yIjoiaHNsKDI1OS42MjYxNjgyMjQzLCA1OS43NzY1MzYzMTI4JSwgODcuOTAxOTYwNzg0MyUpIiwibGFiZWxUZXh0Q29sb3IiOiJibGFjayIsImxvb3BUZXh0Q29sb3IiOiJibGFjayIsIm5vdGVCb3JkZXJDb2xvciI6IiNhYWFhMzMiLCJub3RlQmtnQ29sb3IiOiIjZmZmNWFkIiwibm90ZVRleHRDb2xvciI6ImJsYWNrIiwiYWN0aXZhdGlvbkJvcmRlckNvbG9yIjoiIzY2NiIsImFjdGl2YXRpb25Ca2dDb2xvciI6IiNmNGY0ZjQiLCJzZXF1ZW5jZU51bWJlckNvbG9yIjoid2hpdGUiLCJzZWN0aW9uQmtnQ29sb3IiOiJyZ2JhKDEwMiwgMTAyLCAyNTUsIDAuNDkpIiwiYWx0U2VjdGlvbkJrZ0NvbG9yIjoid2hpdGUiLCJzZWN0aW9uQmtnQ29sb3IyIjoiI2ZmZjQwMCIsInRhc2tCb3JkZXJDb2xvciI6IiM1MzRmYmMiLCJ0YXNrQmtnQ29sb3IiOiIjOGE5MGRkIiwidGFza1RleHRMaWdodENvbG9yIjoid2hpdGUiLCJ0YXNrVGV4dENvbG9yIjoid2hpdGUiLCJ0YXNrVGV4dERhcmtDb2xvciI6ImJsYWNrIiwidGFza1RleHRPdXRzaWRlQ29sb3IiOiJibGFjayIsInRhc2tUZXh0Q2xpY2thYmxlQ29sb3IiOiIjMDAzMTYzIiwiYWN0aXZlVGFza0JvcmRlckNvbG9yIjoiIzUzNGZiYyIsImFjdGl2ZVRhc2tCa2dDb2xvciI6IiNiZmM3ZmYiLCJncmlkQ29sb3IiOiJsaWdodGdyZXkiLCJkb25lVGFza0JrZ0NvbG9yIjoibGlnaHRncmV5IiwiZG9uZVRhc2tCb3JkZXJDb2xvciI6ImdyZXkiLCJjcml0Qm9yZGVyQ29sb3IiOiIjZmY4ODg4IiwiY3JpdEJrZ0NvbG9yIjoicmVkIiwidG9kYXlMaW5lQ29sb3IiOiJyZWQiLCJsYWJlbENvbG9yIjoiYmxhY2siLCJlcnJvckJrZ0NvbG9yIjoiIzU1MjIyMiIsImVycm9yVGV4dENvbG9yIjoiIzU1MjIyMiIsImNsYXNzVGV4dCI6IiMxMzEzMDAiLCJmaWxsVHlwZTAiOiIjRUNFQ0ZGIiwiZmlsbFR5cGUxIjoiI2ZmZmZkZSIsImZpbGxUeXBlMiI6ImhzbCgzMDQsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsImZpbGxUeXBlMyI6ImhzbCgxMjQsIDEwMCUsIDkzLjUyOTQxMTc2NDclKSIsImZpbGxUeXBlNCI6ImhzbCgxNzYsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsImZpbGxUeXBlNSI6ImhzbCgtNCwgMTAwJSwgOTMuNTI5NDExNzY0NyUpIiwiZmlsbFR5cGU2IjoiaHNsKDgsIDEwMCUsIDk2LjI3NDUwOTgwMzklKSIsImZpbGxUeXBlNyI6ImhzbCgxODgsIDEwMCUsIDkzLjUyOTQxMTc2NDclKSJ9fSwidXBkYXRlRWRpdG9yIjp0cnVlfQ)
```txt
stateDiagram-v2
    [*] --> DisabledState
    DisabledState --> CleanSendState
    DisabledState --> DraftLoadingState
    
    CleanSendState --> SimpleSendState
    CleanSendState --> SendingMessageState
    CleanSendState --> ReplayingState
    CleanSendState --> DisabledState
    CleanSendState --> EditingState
    CleanSendState --> QuotingState
    CleanSendState --> SendingAudioMessageState
    
    DraftLoadingState --> CleanSendState
    DraftLoadingState --> ReplayingState
    DraftLoadingState --> SimpleSendState
    
    SimpleSendState --> CleanSendState
    SimpleSendState --> SendingMessageState
    SimpleSendState --> ReplayingState
    SimpleSendState --> DisabledState
    SimpleSendState --> EditingState
    SimpleSendState --> QuotingState
    SimpleSendState --> SendingAudioMessageState

    SendingMessageState --> CleanSendState
    SendingMessageState --> DraftLoadingState

    ReplayingState --> CleanSendState
    ReplayingState --> SendingMessageState
    ReplayingState --> DisabledState
    ReplayingState --> EditingState
    ReplayingState --> ReplayingState

    EditingState --> CleanSendState
    EditingState --> SendingEditMessageState
    EditingState --> ReplayingState
    EditingState --> DisabledState
    EditingState --> EditingState

    QuotingState --> SimpleSendState
    QuotingState --> SendingMessageState
    QuotingState --> EditingState
    QuotingState --> DisabledState
    QuotingState --> QuotingState

    SendingAudioMessageState --> CleanSendState
    SendingAudioMessageState --> DraftLoadingState

    SendingEditMessageState --> CleanSendState
    SendingEditMessageState --> DraftLoadingState
```
